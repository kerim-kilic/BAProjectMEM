---
title: |
  Business Analytics: Damm Company Analysis
author: "Kerim Kiliç, Georgi Gevorgyan, Mar Muñoz, Alejandro Urrea"
date: '`r Sys.Date()`'
output: 
    prettydoc::html_pretty:
      toc: true
    theme: hpstr
    highlight: github
---


```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE,warning = FALSE)
library(tidyverse)
library(janitor)
Sys.setenv(LANG = "sp")
```

# Introduction

Reading in the data from the four tables. 
[Describe each table and their corresponding variables.]

```{r, echo = FALSE, message = FALSE}
retailers <- read.csv("data/t_detallista.csv")
prices <- read.csv("data/material_preu_damm.csv")
quantity <- read.csv("data/t_material_Freqs.csv")
orders <- read.csv("data/t_posiciones.csv")
```

Translating the variable names to English

```{r}
colnames(retailers) <- c("X", "id_retailer", "id_establishment", "country", 
                         "distributor", "region", "area", "category","type", 
                         "type2", "customer")
colnames(prices) <- c("material","price")
colnames(orders) <- c("X", "id_establishment", "date", "material", "customer", 
                      "measure_unit", "quantity")
```

# Data cleaning

Function to clean column titles, remove empty rows and columns, remove constant variables, and remove duplicate values:

```{r}
clean_data <- function(dataset)
{
  ### Clean the names of the variables ###
  dataset <- dataset %>% clean_names()
  ### Remove the empty rows and colums ###
  dataset <- dataset %>% remove_empty(which = c("rows","cols"))
  ### Remove columns with constants ###
  dataset <- dataset %>% remove_constant()
  ### Remove duplicate values ###
  dataset <- dataset %>% distinct()
  return(dataset)
}
```

## Cleaning Data "Orders"

Run the clean_data() function to clean the names of the variables, remove the empty rows and columns, remove the columns with only a constant value, remove the duplicate values, and remove the column x since it does not give any important information.

```{r}
orders <- clean_data(orders) %>% select(-x)
```

"id_establiment" variable  
```{r}
orders %>% tabyl(id_establishment) %>% select (id_establishment) %>% summary()
```

<!-- We delete the NA values -->
<!-- ```{r} -->
<!-- orders <- orders %>% filter(!is.na(id_establishment)) -->
<!-- ``` -->

"Date" variable
```{r}
orders <- orders %>% mutate(date =as.Date(date, format = "%d.%m.%Y"))
```

We look at the first dates and last dates
```{r}
orders$date %>% head(20)
orders$date %>% tail(20)
```

We assume that 0202 should be 2002, that 2218 is 2018, that 2202 is 2022 and that 2119 is 2019 

```{r}
index <- c(1:nrow(orders))
for (i in index) {
  if (orders$date[i] == "0202-03-01"){
    orders$date[i] <- "2002-03-01"
  }
  else if (orders$date[i] == "2218-04-09"){
    orders$date[i] <- "2018-04-09"
  }
  else if (orders$date[i] == "2202-12-20"){
    orders$date[i] <- "2022-12-20"
  }
  else if (orders$date[i] == "2119-12-05"){
    orders$date[i] <- "2019-12-05"
  }
}
```

"Customer" variable

We delete the NA's
```{r}
orders %>% tabyl(customer) %>% select (customer) %>% summary()
orders <- orders %>% filter (!is.na(customer))
```


"Unit" variable
```{r}
orders %>% tabyl(measure_unit)
empty_unit <- nrow(orders %>% filter(is.na(measure_unit)))
empty_unit
```
there are `r empty_unit` with no unit of measure

"quantity" variable
```{r}
orders %>% tabyl(quantity) %>% select (quantity) %>% summary()
```

```{r}
zero_quantity <- nrow(orders[orders$quantity == 0,])

```
There are `r zero_quantity` with zero quantity

Delete those rows with a 0 in quantity 
```{r}
orders <- orders %>% filter(quantity != 0)
```

## Cleaning Quantity Data
Remove the X variable and check na values per column

```{r}
quantity <- clean_data(quantity) %>% select(-x)
which(colSums(is.na(quantity)) > 0)
```
Remove the na values of the material column
```{r}
quantity <- quantity%>%filter(!is.na(material))
```


# Adding the type of product

```{r}
prices <- prices %>%
  mutate(type = case_when(grepl("AK", material,  fixed = TRUE) ~ "AK",
                          grepl("BOCK", material,  fixed = TRUE) ~ "BOCK",
                          grepl("COMPLOT", material,  fixed = TRUE) ~ "COMPLOT",
                          grepl("LEMON", material,  fixed = TRUE) ~ "LEMON",
                          grepl("ESTRELLA", material,  fixed = TRUE) ~ "ESTRELLA",
                          grepl("FREE", material,  fixed = TRUE) ~ "FREE",
                          grepl("INEDIT", material,  fixed = TRUE) ~ "INEDIT",
                          grepl("SAAZ", material,  fixed = TRUE) ~ "SAAZ",
                          grepl("TURIA", material,  fixed = TRUE) ~ "TURIA",
                          grepl("VOLL", material,  fixed = TRUE) ~ "VOLL",
                          grepl("WEISS", material,  fixed = TRUE) ~ "WEISS",
                          grepl("XIBECA", material,  fixed = TRUE) ~ "XIBECA",
                          grepl("GENERAL", material,  fixed = TRUE) ~ "GENERAL",
                          grepl("GRUPO DAMM", material,  fixed = TRUE) ~ "GRUPO DAMM",
                          grepl("DAURA", material,  fixed = TRUE) ~ "DAURA",
                          grepl("DAMM", material,  fixed = TRUE) ~ "DAMM",
                          grepl("EQUILATER", material,  fixed = TRUE) ~ "EQUILATER"))
```

# Merging orders and prices

```{r}
# Merge orders and prices
orders_prices <- merge(orders,prices,by="material")
```

# General overview of the data 

Counting the number of times a type of article appears in an order. 

```{r}
orders_prices %>%
  group_by(type)%>%
  summarise(count = n()) %>%
  mutate(percentage =  round((count/nrow(orders_prices))*100,2)) %>%
  ggplot(aes(reorder(type, percentage), percentage, fill=type))+
  geom_bar(stat="identity", position = "dodge") + 
  coord_flip() + 
  labs(title= "% of orders per product type", y = "% of Orders", x = "Type of prodcut ") +  
  theme(legend.position = "none")
```

Order lines over time. We use order lines instead of orders, because there can be orders with just one line, and orders with a lot of lines, and they are not comparable. 

```{r}
orders$Month <- as.Date(cut(orders$date,
                            breaks = "month"))


orders %>% filter(date >= "2018-01-01" & date <= "2021-12-31") %>% group_by(Month) %>% 
  summarise(count = n()) %>% ggplot(aes(Month, count)) + geom_line() +
  geom_point() 
```

Top clients 
```{r}
tab_1 <- orders_prices %>%
  group_by(id_establishment)%>%
  summarise(count = n()) 

tab_2 <- tab_1[order(-tab_1$count),]

tab_2 %>% head(15)%>%
  ggplot(aes(reorder(id_establishment, count), count, fill=id_establishment))+
  geom_bar(stat="identity", position = "dodge") + 
  coord_flip() + 
  labs(title= "Order lines per client", y = " Order lines", x = "Client ") +  
  theme(legend.position = "none")
```

clients with only 1 order line 

```{r}
tab_2 %>% filter(count == 1) %>% nrow()
```
