---
title: |
  Business Analytics: Damm Company Analysis
author: "Kerim Kiliç, Georgi Gevorgyan, Mar Muñoz, Alejandro Urrea"
date: '`r Sys.Date()`'
output: 
    prettydoc::html_pretty:
      toc: true
    theme: hpstr
    highlight: github
---


```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE,warning = FALSE)
library(tidyverse)
library(janitor)
Sys.setenv(LANG = "sp")
```

# Introduction

Reading in the data and cleaning the column titles

```{r, echo = FALSE, message = FALSE}
t_detallista <- read.csv("data/t_detallista.csv")
t_material <- read.csv("data/material_preu_damm.csv")
t_material_freqs <- read.csv("data/t_material_Freqs.csv")
t_posiciones <- read.csv("data/t_posiciones.csv")
```



# Data cleaning

```{r, echo=FALSE, message=FALSE}
retailers <- t_detallista%>%clean_names()
prices <- t_material%>%clean_names()
quantity <- t_material_freqs%>%clean_names()
orders <- t_posiciones%>%clean_names()
```


```{r}
colnames(retailers) <- c("X", "id_retailer", "id_establishment", "country", "distributor", "region",
                         "area", "category","type", "type2", "customer")
colnames(prices) <- c("material","price")
colnames(orders) <- c("X", "id_establishment", "date", "material", "customer", "measure_unit", "quantity")
```


### Cleaning Data "Orders"

Check the top and the bottom of the data set
```{r}
orders %>% head(3)
orders %>% tail(3)
```

There's no empty rows at the beginning or at the end of the dataset

Check duplicates
```{r}
orders %>% get_dupes()
```
There are no duplicates

"X" variable

This column doesn't give information, we can delete it 
```{r}
orders <- subset(orders, select = -c(X))
```

"id_establiment" variable  
```{r}
orders %>% tabyl(id_establishment) %>% select (id_establishment) %>% summary()
```

We delete the NA values
```{r}
orders <- orders %>% filter (id_establishment != "NA")
```

"Date" variable
```{r}
orders <- orders %>% mutate(date =as.Date(date, format = "%d.%m.%Y"))

```

We look at the first dates and last dates
```{r}
orders$date %>% head(20)
orders$date %>% tail(20)
```

We assume that 0202 should be 2002, that 2218 is 2018, that 2202 is 2022 and that 2119 is 2019 
```{r}
index <- c(1:nrow(orders))
for (i in index) {
  if (orders$date[i] == "0202-03-01"){
    orders$date[i] <- "2002-03-01"
  }
  else if (orders$date[i] == "2218-04-09"){
    orders$date[i] <- "2018-04-09"
  }
  else if (orders$date[i] == "2202-12-20"){
    orders$date[i] <- "2022-12-20"
  }
  else if (orders$date[i] == "2119-12-05"){
    orders$date[i] <- "2019-12-05"
  }
}
```

"Customer" variable

We delete the NA's
```{r}
orders %>% tabyl(customer) %>% select (customer) %>% summary()
orders <- orders %>% filter (customer != "NA")
```


"Unit" variable
```{r}
orders %>% tabyl(measure_unit)
empty_unit <- nrow(orders %>% filter(is.na(measure_unit)))
empty_unit
```
there are `r empty_unit` with no unit of measure

"quantity" variable
```{r}
orders %>% tabyl(quantity) %>% select (quantity) %>% summary()
```

```{r}
zero_quantity <- nrow(orders[orders$quantity == 0,])

```
There are `r zero_quantity` with zero quantity

Delete those rows with a 0 in quantity and NA in the unit
```{r}
orders <- orders[!(orders$quantity == 0 & orders$measure_unit == NA),]
```

### Cleaning Quantity Data
Remove the X variable and check na values per column

```{r}
quantity$x <- NULL
which(colSums(is.na(quantity)) > 0)
```
Remove the na values of the material column
```{r}
quantity <- quantity%>%filter(!is.na(material))
```


# Adding the type of product

```{r}
prices <- prices %>% mutate(type = NA)


index <- c(1:nrow(prices))

for (i in index) {
  AK <- grepl("AK", prices$material[i],  fixed = TRUE)
  BOCK <- grepl("BOCK", prices$material[i],  fixed = TRUE)
  COMPLOT <- grepl("COMPLOT", prices$material[i],  fixed = TRUE)
  LEMON <- grepl("LEMON", prices$material[i],  fixed = TRUE)
  ESTRELLA <- grepl("ESTRELLA", prices$material[i],  fixed = TRUE)
  FREE <- grepl("FREE", prices$material[i],  fixed = TRUE)
  INEDIT <- grepl("INEDIT", prices$material[i],  fixed = TRUE)
  SAAZ <- grepl("SAAZ", prices$material[i],  fixed = TRUE)
  TURIA <- grepl("TURIA", prices$material[i],  fixed = TRUE)
  VOLL <- grepl("VOLL", prices$material[i],  fixed = TRUE)
  WEISS <- grepl("WEISS", prices$material[i],  fixed = TRUE)
  XIBECA <- grepl("XIBECA", prices$material[i],  fixed = TRUE)
  GENERAL <- grepl("GENERAL", prices$material[i],  fixed = TRUE)
  
  if(AK == TRUE) {
    prices$type[i] <- "AK"
  }
  else if(BOCK == TRUE) {
    prices$type[i] <- "BOCK"
  }
  else if(COMPLOT == TRUE) {
    prices$type[i] <- "COMPLOT"
  }
  else if(LEMON == TRUE) {
    prices$type[i] <- "LEMON"
  }
  else if(ESTRELLA == TRUE) {
    prices$type[i] <- "ESTRELLA"
  }
  else if(FREE == TRUE) {
    prices$type[i] <- "FREE"
  }
  else if(INEDIT == TRUE) {
    prices$type[i] <- "INEDIT"
  }
  else if(SAAZ == TRUE) {
    prices$type[i] <- "SAAZ"
  }
  else if(TURIA == TRUE) {
    prices$type[i] <- "TURIA"
  }
  else if(VOLL == TRUE) {
    prices$type[i] <- "VOLL"
  }
  else if(WEISS == TRUE) {
    prices$type[i] <- "WEISS"
  }
  else if(XIBECA == TRUE) {
    prices$type[i] <- "XIBECA"
  }
  else if(GENERAL == TRUE) {
    prices$type[i] <- "GENERAL"
  }
  else {
    prices$type[i] <- "Other"
  }
  a<- c(AK, BOCK, COMPLOT, LEMON, ESTRELLA, FREE, INEDIT, SAAZ , TURIA, VOLL, WEISS, XIBECA, GENERAL) 
  a <- FALSE  
}

```

# Merging orders and prices

```{r}
# Merge orders and prices
orders_prices <- merge(orders,prices,by="material")
```

# General overview of the data 
Counting the number of times a type of article appears in an order. 

```{r}
orders_prices %>%
  group_by(type)%>%
  summarise(count = n()) %>%
  mutate(percentage =  round((count/nrow(orders_prices))*100,2)) %>%
  ggplot(aes(reorder(type, percentage), percentage, fill=type))+
  geom_bar(stat="identity", position = "dodge") + 
  coord_flip() + 
  labs(title= "% of orders per product type", y = "% of Orders", x = "Type of prodcut ") +  
  theme(legend.position = "none")
```

Order lines over time. We use order lines instead of orders, because there can be orders with just one line, and orders with a lot of lines, and they are not comparable. 

```{r}
orders$Month <- as.Date(cut(orders$date,
                            breaks = "month"))


orders %>% filter(date >= "2018-01-01" & date <= "2021-12-31") %>% group_by(Month) %>% 
  summarise(count = n()) %>% ggplot(aes(Month, count)) + geom_line() +
  geom_point() 
```

Top clients 
```{r}
tab_1 <- orders_prices %>%
  group_by(id_establishment)%>%
  summarise(count = n()) 

tab_2 <- tab_1[order(-tab_1$count),]

tab_2 %>% head(15)%>%
  ggplot(aes(reorder(id_establishment, count), count, fill=id_establishment))+
  geom_bar(stat="identity", position = "dodge") + 
  coord_flip() + 
  labs(title= "Order lines per client", y = " Order lines", x = "Client ") +  
  theme(legend.position = "none")
```

clients with only 1 order line 

```{r}
tab_2 %>% filter(count == 1) %>% nrow()
```



